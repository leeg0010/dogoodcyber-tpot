input {
  # Honeypot Application Logs
  file {
    path => ["/data/*/log/*.json", "/data/*/log/*.log"]
    codec => json
    start_position => "beginning"
  }

  # Docker Container Logs (stdout/stderr from all containers)
  file {
    path => "/var/lib/docker/containers/*/*.log"
    type => "docker-container"
    codec => json
    start_position => "beginning"
  }

  # System Journal Export (includes auth, kernel, docker daemon, all systemd units)
  file {
    path => "/var/log/journal-export.log"
    type => "systemd-journal"
    codec => json
    start_position => "beginning"
  }

  # Package Management (security updates, installations)
  file {
    path => "/var/log/dpkg.log"
    type => "dpkg"
    start_position => "beginning"
  }

  # Intrusion Prevention
  file {
    path => "/var/log/fail2ban.log"
    type => "fail2ban"
    start_position => "beginning"
  }

  # Alternative Log (package alternatives, useful for tracking system changes)
  file {
    path => "/var/log/alternatives.log"
    type => "alternatives"
    start_position => "beginning"
  }

  # Boot Log (system initialization, critical for diagnosing boot issues)
  file {
    path => "/var/log/boot.log"
    type => "boot"
    start_position => "beginning"
  }
}

filter {
  # Parse Docker container logs
  if [type] == "docker-container" {
    if [log] {
      mutate {
        rename => { "log" => "message" }
      }
    }
    if [stream] {
      mutate {
        rename => { "stream" => "docker_stream" }
      }
    }
    if [time] {
      date {
        match => [ "time", "ISO8601" ]
        target => "@timestamp"
        remove_field => [ "time" ]
      }
    }
  }

  # Fix host field - extract container_id as string
  if [host] {
    if [host][name] {
      mutate {
        add_field => { "container_id" => "%{[host][name]}" }
        remove_field => [ "host" ]
      }
    } else {
      mutate {
        rename => { "host" => "container_id" }
      }
    }
  }
  
  # Copy log.file.path to path field for dashboard compatibility
  if [log][file][path] {
    mutate {
      add_field => { "path" => "%{[log][file][path]}" }
    }
  }
  
  # Add pam-t-f hostname to all events
  mutate {
    add_field => { "[@metadata][beat]" => "pam-t-f" }
    add_field => { "honeypot_hostname" => "pam-t-f" }
  }

  # Parse custom timestamp formats for correlation
  if [timestamp] {
    if [path] =~ /p0f/ {
      date {
        match => [ "timestamp", "yyyy/MM/dd HH:mm:ss" ]
        target => "@timestamp"
        remove_field => [ "timestamp" ]
      }
    }
    else if [path] =~ /heralding/ {
      date {
        match => [ "timestamp", "yyyy-MM-dd HH:mm:ss.SSSSSS" ]
        target => "@timestamp"
        remove_field => [ "timestamp" ]
      }
    }
    else {
      date {
        match => [ "timestamp", "ISO8601" ]
        target => "@timestamp"
        remove_field => [ "timestamp" ]
      }
    }
  }
}

output {
  elasticsearch {
    hosts => ["192.168.1.100:9200"]
    index => "logstash-%{+YYYY.MM.dd}"
    pipeline => "50-tpot-routing-and-enrichment"
  }
}
